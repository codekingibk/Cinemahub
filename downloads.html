<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Downloads - CinemaHub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Grotesk:wght@400..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Clerk Authentication SDK -->
    <script
        async
        crossorigin="anonymous"
        data-clerk-publishable-key="pk_test_ZXhjaXRpbmctcGlnbGV0LTIzLmNsZXJrLmFjY291bnRzLmRldiQ"
        src="https://exciting-piglet-23.clerk.accounts.dev/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
        type="text/javascript"
    ></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #07070c;
            background-image: radial-gradient(circle at 20% 30%, rgba(45, 20, 80, 0.25) 0%, transparent 40%),
                              radial-gradient(circle at 80% 70%, rgba(90, 30, 120, 0.15) 0%, transparent 45%);
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: #ffffff;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .site-header {
            padding: 1.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            backdrop-filter: blur(10px);
            background: rgba(7,7,12,0.7);
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }

        .brand-mark {
            background: linear-gradient(145deg, #aa5eff, #7c3ced);
            padding: 0.5rem;
            border-radius: 8px;
            color: white;
            font-size: 1.4rem;
            box-shadow: 0 0 12px #9147ff55;
        }

        .brand-text {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            background: linear-gradient(to right, #ffffff, #e0d0ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 2.8rem;
            font-weight: 500;
        }

        .nav-links a {
            color: #c2c2d6;
            transition: 0.2s;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            text-decoration: none;
            border-bottom: 2px solid transparent;
            padding-bottom: 0.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links a:hover {
            color: white;
            border-bottom-color: #aa5eff;
        }

        h1, h2 {
            font-family: 'Bebas Neue', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        h1 {
            font-size: 3.5rem;
            line-height: 1.1;
            margin-bottom: 1.5rem;
        }

        h2 {
            font-size: 2rem;
            margin-bottom: 2rem;
        }

        h3 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .muted {
            color: #9191a8;
            font-size: 0.95rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            padding: 0.8rem 2rem;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            transition: 0.15s ease;
            border: none;
            cursor: pointer;
            text-decoration: none;
        }

        .btn.primary {
            background: linear-gradient(145deg, #9147ff, #7735d8);
            box-shadow: 0 10px 20px -5px #5e2ab3;
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn.primary:hover {
            background: #a35eff;
            transform: translateY(-2px);
        }

        main {
            padding: 3rem 0;
            min-height: calc(100vh - 200px);
        }

        .downloads-hero {
            margin-bottom: 4rem;
        }

        .downloads-section {
            margin-bottom: 3rem;
        }

        .downloads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .download-card {
            background: rgba(13, 13, 20, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 2rem;
            border-radius: 24px;
            text-align: center;
            transition: 0.3s;
        }

        .download-card:hover {
            border-color: rgba(170, 94, 255, 0.3);
            background: rgba(30, 30, 45, 0.8);
            transform: translateY(-4px);
        }

        .download-card i {
            font-size: 3rem;
            color: #bc9aff;
            margin-bottom: 1rem;
        }

        .download-card h3 {
            margin-bottom: 0.5rem;
        }

        .empty-state {
            background: rgba(13, 13, 20, 0.7);
            backdrop-filter: blur(16px);
            border: 2px dashed rgba(255,255,255,0.1);
            padding: 4rem 2rem;
            border-radius: 32px;
            text-align: center;
            margin: 2rem 0;
        }

        .empty-state i {
            font-size: 4rem;
            color: #6b6b85;
            margin-bottom: 1.5rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            color: #cbcbdb;
            margin-bottom: 1rem;
        }

        .empty-state p {
            max-width: 400px;
            margin: 0 auto 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: rgba(13, 13, 20, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 2rem;
            border-radius: 24px;
        }

        .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            color: #aa5eff;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #9191a8;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .footer {
            background: #030307;
            padding-top: 4rem;
            padding-bottom: 2rem;
            border-top: 1px solid #1a1a28;
            margin-top: 4rem;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .footer a {
            display: block;
            color: #aaaac0;
            margin: 0.8rem 0;
            font-size: 0.95rem;
            text-decoration: none;
            transition: 0.2s;
        }

        .footer a:hover {
            color: #ffffff;
        }

        .footer h4 {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .footer-bottom {
            text-align: center;
            padding: 2rem 0;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        
        /* Mobile responsive styles */
        @media (max-width: 1024px) {
            .footer-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            /* Mobile Bottom Navigation */
            body {
                padding-left: 0;
                padding-bottom: 80px;
            }

            .site-header {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                width: 100%;
                height: auto;
                padding: 0.8rem 0;
                border-right: none;
                border-top: 1px solid rgba(255,255,255,0.08);
                border-bottom: none;
                background: rgba(7,7,12,0.95);
                backdrop-filter: blur(20px);
                z-index: 1000;
            }

            .nav {
                flex-direction: row;
                justify-content: space-around;
                align-items: center;
                gap: 0;
                height: auto;
                width: 100%;
            }

            .brand {
                display: none;
            }

            .nav-links {
                flex-direction: row;
                width: 100%;
                justify-content: space-around;
                align-items: center;
                gap: 0;
            }

            .nav-links a {
                flex-direction: column;
                justify-content: center;
                font-size: 0.7rem;
                padding: 0;
                border: none;
                gap: 0.4rem;
                color: #9191a8;
                width: auto;
            }
            
            .nav-links a.active {
                color: #aa5eff;
            }

            .nav-links a i {
                font-size: 1.4rem;
                margin-bottom: 2px;
            }
            
            .nav-links a span {
                display: block !important;
                font-size: 0.65rem;
                font-weight: 500;
                letter-spacing: 0.05em;
            }

            .nav-actions {
                display: none !important;
            }

            h1 {
                font-size: 2.5rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            .brand-text {
                font-size: 1.5rem;
            }
            
            .download-item {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
                gap: 1rem;
                padding: 1.25rem;
            }
            
            .download-info {
                width: 100%;
            }
            
            .download-meta {
                flex-wrap: wrap;
                gap: 0.75rem;
            }
            
            .download-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1.5rem;
            }
            
            .container {
                padding: 0 1rem;
            }
            
            .empty-state {
                padding: 2rem 1rem;
            }
        }
        
        @media (max-width: 640px) {
            .footer-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            .stat-card {
                padding: 1.5rem;
            }
            
            .download-icon {
                width: 48px;
                height: 48px;
                font-size: 1.25rem;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
    <style>
        @media (max-width: 420px) {
            .container { max-width: 100% !important; margin: 0 !important; padding: 0 12px !important; }
            .nav-links { gap: 0.6rem !important; }
            h1 { font-size: 1.8rem !important; }
            h2 { font-size: 1.2rem !important; }
            .hero, .hero-grid, .details-layout { grid-template-columns: 1fr !important; gap: 1rem !important; }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <nav class="nav">
                <a class="brand" href="index.html">
                    <span class="brand-mark"><i class="fas fa-film"></i></span>
                    <span class="brand-text">CinemaHub</span>
                </a>
                <div class="nav-links">
                    <a href="index.html"><i class="fas fa-house"></i><span>Home</span></a>
                    <a href="about.html"><i class="fas fa-circle-info"></i><span>About</span></a>
                    <a href="downloads.html"><i class="fas fa-download"></i><span>Downloads</span></a>
                    <a href="profile.html"><i class="fas fa-user"></i><span>Profile</span></a>
                </div>
                <div class="nav-actions" style="display: flex; gap: 1rem; align-items: center;">
                    <div id="authButtons" style="display: flex; gap: 1rem;">
                        <button onclick="openSignIn()" style="border: none; background: none; cursor: pointer; font: inherit; color: #c2c2d6; text-transform: uppercase; letter-spacing: 0.15em; font-size: 0.95rem;">Log in</button>
                        <button onclick="openSignUp()" class="btn primary" style="cursor: pointer;">Sign up</button>
                    </div>
                    <div id="userProfile" style="display: none; gap: 1rem; align-items: center;"></div>
                </div>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Hero -->
            <section class="downloads-hero">
                <h1>Your Downloads</h1>
                <p class="muted">Manage your offline library. Download in multiple qualities and stream anywhere.</p>
            </section>

            <!-- Empty State / Content Placeholder -->
            <section class="downloads-section" id="downloadsList">
                <div class="spinner" style="text-align: center; padding: 4rem;">
                    <div style="width: 40px; height: 40px; border: 4px solid rgba(145, 71, 255, 0.2); border-top-color: #9147ff; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto;"></div>
                    <p style="margin-top: 1rem; color: #9191a8;">Loading your downloads...</p>
                </div>
            </section>

            <!-- Download Features -->
            <section class="downloads-section">
                <h2>Download Benefits</h2>
                <div class="downloads-grid">
                    <div class="download-card">
                        <i class="fas fa-wifi-off"></i>
                        <h3>Watch Offline</h3>
                        <p class="muted">Stream any time, no internet needed.</p>
                    </div>
                    <div class="download-card">
                        <i class="fas fa-mobile-alt"></i>
                        <h3>Any Device</h3>
                        <p class="muted">Download to phone, tablet, or computer.</p>
                    </div>
                    <div class="download-card">
                        <i class="fas fa-hd"></i>
                        <h3>Multiple Qualities</h3>
                        <p class="muted">Choose HD, SD, or mobile quality for your needs.</p>
                    </div>
                    <div class="download-card">
                        <i class="fas fa-expandable"></i>
                        <h3>More Control</h3>
                        <p class="muted">Delete downloads to save space when done.</p>
                    </div>
                </div>
            </section>

            <!-- Storage Info -->
            <section class="downloads-section">
                <h2>Download Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalDownloads">0</div>
                        <div class="stat-label">Total Downloads</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="moviesDownloaded">0</div>
                        <div class="stat-label">Movies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="subtitlesDownloaded">0</div>
                        <div class="stat-label">Subtitles</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="storageUsed">0 MB</div>
                        <div class="stat-label">Storage Used (1 GB limit)</div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <div class="container footer-grid">
            <div>
                <div class="brand" style="margin-bottom: 1rem;">
                    <span class="brand-mark"><i class="fas fa-film"></i></span>
                    <span class="brand-text">CinemaHub</span>
                </div>
                <p class="muted">Discovery, streaming, and downloads built for movie lovers.</p>
            </div>
            <div>
                <h4>Explore</h4>
                <a href="index.html">Home</a>
                <a href="about.html">About</a>
                <a href="downloads.html">Downloads</a>
            </div>
            <div>
                <h4>Account</h4>
                <a href="login.html">Log in</a>
                <a href="signup.html">Sign up</a>
            </div>
            <div>
                <h4>Data</h4>
                <p class="muted">Powered by Free Movie DB API.</p>
                <a href="https://imdb.iamidiotareyoutoo.com/docs/index.html" target="_blank" rel="noopener">API Docs</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p class="muted">&copy; 2026 CinemaHub. All rights reserved.</p>
        </div>
    </footer>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes indeterminate {
            0% { transform: translateX(-80%); }
            50% { transform: translateX(100%); }
            100% { transform: translateX(260%); }
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #9147ff;
            box-shadow: 0 0 12px rgba(145, 71, 255, 0.4);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: #fff;
        }
        
        .btn-outline {
            padding: 0.5rem 1.2rem;
            border: 1px solid rgba(145, 71, 255, 0.5);
            background: rgba(145, 71, 255, 0.1);
            color: #aa5eff;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            transition: all 0.2s;
        }
        
        .btn-outline:hover {
            background: rgba(145, 71, 255, 0.2);
            border-color: #9147ff;
            color: #fff;
        }

        .download-item {
            background: rgba(13, 13, 20, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.2s;
        }
        
        .download-item:hover {
            border-color: rgba(170, 94, 255, 0.3);
            background: rgba(30, 30, 45, 0.8);
        }
        
        .download-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }
        
        .download-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(145deg, #9147ff, #7735d8);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        
        .download-details h4 {
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
        }
        
        .download-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: #9191a8;
        }
        
        .download-actions {
            display: flex;
            gap: 0.5rem;
        }

        .download-progress {
            width: 100%;
            height: 24px;
            background: rgba(255,255,255,0.08);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.6rem;
            border: 1px solid rgba(145,71,255,0.2);
            position: relative;
            display: flex;
            align-items: center;
        }

        .download-progress span {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: linear-gradient(90deg, #9147ff 0%, #aa5eff 100%);
            width: 0%;
            transition: width 0.3s ease;
            min-width: 2px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }

        .download-progress.indeterminate span {
            width: 25%;
            background: linear-gradient(90deg, rgba(145,71,255,0.3) 0%, #9147ff 50%, rgba(170,94,255,0.3) 100%);
            animation: indeterminate 1.5s ease-in-out infinite;
        }

        .download-status {
            font-size: 0.85rem;
            color: #bc9aff;
            margin-top: 0.4rem;
        }

        .offline-player {
            margin-top: 1rem;
            background: rgba(12, 12, 20, 0.8);
            border-radius: 16px;
            padding: 1rem;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .offline-player video {
            width: 100%;
            border-radius: 12px;
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .btn-icon:hover {
            background: rgba(145, 71, 255, 0.2);
            border-color: #9147ff;
        }
    </style>

    <script src="clerk-auth.js"></script>
    <script>
        // Download history management

        // Initialize page
        async function initializeDownloadsPage() {
            try {
                if (window.location.protocol === 'file:') {
                    const downloadsList = document.getElementById('downloadsList');
                    if (downloadsList) {
                        downloadsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-triangle-exclamation"></i>
                                <h3>Offline downloads need a local server</h3>
                                <p class="muted">Open the site at <strong>http://localhost:5000</strong> so your downloads sync across pages.</p>
                                <a href="http://localhost:5000" class="btn primary">Open CinemaHub</a>
                            </div>
                        `;
                        downloadsList.dataset.loaded = 'true';
                    }
                }

                // Wait for Clerk SDK
                let attempts = 0;
                while (!window.Clerk && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (!window.Clerk) {
                    showError('Authentication system failed to load.');
                    return;
                }

                clerk = window.Clerk;
                window.clerk = clerk;
                await clerk.load({
                    publishableKey: 'pk_test_ZXhjaXRpbmctcGlnbGV0LTIzLmNsZXJrLmFjY291bnRzLmRldiQ',
                });
                
                isClerkReady = true;
                window.isClerkReady = true;

                // Check authentication
                if (!clerk.user) {
                    showUnauthenticatedState();
                    return;
                }

                // Load downloads
                loadDownloads();
                loadDownloadStats();
                updateNavProfile();

                // Fallback if something blocks rendering
                setTimeout(() => {
                    const downloadsList = document.getElementById('downloadsList');
                    if (downloadsList && !downloadsList.dataset.loaded) {
                        downloadsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-download"></i>
                                <h3>Downloads not loading</h3>
                                <p class="muted">Please refresh this page or sign in again.</p>
                                <button onclick="window.location.reload()" class="btn primary">Refresh</button>
                            </div>
                        `;
                    }
                }, 3000);

            } catch (error) {
                console.error('Failed to initialize:', error);
                showError('Failed to load page.');
            }
        }

        // Update nav with user profile
        function updateNavProfile() {
            const user = clerk.user;
            const authButtons = document.getElementById('authButtons');
            const userProfile = document.getElementById('userProfile');

            if (user) {
                const userName = user.firstName || user.username || 'User';
                const userImage = user.imageUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=9147ff&color=fff`;

                authButtons.style.display = 'none';
                userProfile.style.display = 'flex';
                userProfile.innerHTML = `
                    <div class="user-info">
                        <img src="${userImage}" alt="${userName}" class="user-avatar">
                        <span class="user-name">${userName}</span>
                    </div>
                    <button onclick="signOutUser()" class="btn-outline" style="border: none;">Sign Out</button>
                `;
            } else {
                authButtons.style.display = 'flex';
                userProfile.style.display = 'none';
            }
        }

        const OFFLINE_CACHE_NAME = 'cinemahub-offline-v1';
        const MAX_OFFLINE_BYTES = 1024 * 1024 * 1024; // 1 GB
        let progressTimer = null;

        // Load download history
        function loadDownloads() {
            const userId = clerk.user?.id;
            if (!userId) {
                showUnauthenticatedState();
                return;
            }

            const downloads = getOfflineLibrary(userId)
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            const downloadsList = document.getElementById('downloadsList');

            if (downloads.length === 0) {
                downloadsList.dataset.loaded = 'true';
                downloadsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-cloud-download-alt"></i>
                        <h3>No downloads yet</h3>
                        <p class="muted">Start downloading your favorite movies and shows to watch offline anytime, anywhere.</p>
                        <a href="index.html" class="btn primary">
                            <i class="fas fa-search"></i> Browse Movies
                        </a>
                    </div>
                `;
                return;
            }

            // Display downloads
            const downloadsHTML = downloads.map(item => {
                const hasProgress = typeof item.progress === 'number';
                const statusLabel = item.status === 'downloading'
                    ? (hasProgress ? `Downloading ${item.progress}%` : 'Downloading...')
                    : item.status === 'ready'
                        ? 'Ready for offline viewing'
                        : item.status === 'failed'
                            ? `Failed: ${item.error || 'Download failed'}`
                            : 'Queued';

                const progressBar = item.status === 'downloading'
                    ? `<div class="download-progress ${hasProgress ? '' : 'indeterminate'}"><span style="width: ${hasProgress ? item.progress : 25}%;">${hasProgress ? `${item.progress}%` : ''}</span></div>`
                    : '';

                const totalBytes = item.totalBytes || item.size || 0;
                const receivedBytes = item.receivedBytes || (item.progress ? Math.round((item.progress / 100) * totalBytes) : 0);
                const metaSize = totalBytes
                    ? `<span><i class="fas fa-database"></i> ${formatBytes(receivedBytes || totalBytes)}${receivedBytes && totalBytes ? ` / ${formatBytes(totalBytes)}` : ''}</span>`
                    : '';

                const playButton = item.status === 'ready' && item.type !== 'subtitle'
                    ? `<button onclick="playOfflineItem('${item.id}')" class="btn-icon" title="Play offline"><i class="fas fa-play"></i></button>`
                    : '';

                const openButton = item.status === 'ready' && item.type === 'subtitle'
                    ? `<button onclick="openOfflineSubtitle('${item.id}')" class="btn-icon" title="Open subtitle"><i class="fas fa-file-alt"></i></button>`
                    : '';

                const retryButton = item.status === 'failed'
                    ? `<button onclick="retryOfflineItem('${item.id}')" class="btn-icon" title="Retry"><i class="fas fa-rotate-right"></i></button>`
                    : '';

                return `
                <div class="download-item">
                    <div class="download-info">
                        <div class="download-icon">
                            <i class="fas fa-${item.type === 'subtitle' ? 'closed-captioning' : 'film'}"></i>
                        </div>
                        <div class="download-details">
                            <h4>${item.title}</h4>
                            <div class="download-meta">
                                <span><i class="fas fa-calendar"></i> ${formatDate(item.createdAt || Date.now())}</span>
                                <span><i class="fas fa-${item.type === 'subtitle' ? 'language' : 'hd'}"></i> ${item.quality || item.language || 'N/A'}</span>
                                ${metaSize}
                                ${item.type === 'subtitle' ? '<span class="badge" style="background: rgba(145, 71, 255, 0.2); color: #aa5eff; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem;">Subtitle</span>' : ''}
                            </div>
                            <div class="download-status">${statusLabel}</div>
                            ${progressBar}
                            <div class="offline-player" id="player-${item.id}" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="download-actions">
                        ${playButton}
                        ${openButton}
                        ${retryButton}
                        <button onclick="removeDownload('${item.id}')" class="btn-icon" title="Remove from library">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            }).join('');

            downloadsList.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0;">Recent Downloads</h2>
                    <button onclick="clearAllDownloads()" class="btn secondary" style="padding: 0.6rem 1.5rem; font-size: 0.85rem;">
                        <i class="fas fa-trash"></i> Clear History
                    </button>
                </div>
                ${downloadsHTML}
            `;

            downloadsList.dataset.loaded = 'true';

            scheduleProgressRefresh(downloads);
        }

        // Load download statistics
        function loadDownloadStats() {
            const userId = clerk.user?.id;
            if (!userId) return;

            const downloads = getOfflineLibrary(userId);
            const movies = downloads.filter(d => d.type === 'movie');
            const subtitles = downloads.filter(d => d.type === 'subtitle');
            const storageUsed = getOfflineUsage(downloads);

            document.getElementById('totalDownloads').textContent = downloads.length;
            document.getElementById('moviesDownloaded').textContent = movies.length;
            document.getElementById('subtitlesDownloaded').textContent = subtitles.length;
            document.getElementById('storageUsed').textContent = `${formatBytes(storageUsed)}`;
        }

        // Offline library helpers
        function getOfflineLibrary(userId) {
            try {
                const key = `offlineLibrary_${userId}`;
                const library = localStorage.getItem(key);
                return library ? JSON.parse(library) : [];
            } catch (error) {
                console.error('Failed to get offline library:', error);
                return [];
            }
        }

        function saveOfflineLibrary(userId, library) {
            try {
                const key = `offlineLibrary_${userId}`;
                localStorage.setItem(key, JSON.stringify(library));
            } catch (error) {
                console.error('Failed to save offline library:', error);
            }
        }

        function updateOfflineEntry(userId, entryId, updates) {
            const library = getOfflineLibrary(userId);
            const index = library.findIndex(item => item.id === entryId);
            if (index === -1) return;
            library[index] = { ...library[index], ...updates };
            saveOfflineLibrary(userId, library);
        }

        function getOfflineUsage(library) {
            return library.reduce((total, item) => total + (item.size || 0), 0);
        }

        function scheduleProgressRefresh(downloads) {
            const hasActive = downloads.some(item => item.status === 'downloading');
            if (hasActive && !progressTimer) {
                progressTimer = setInterval(() => {
                    loadDownloads();
                    loadDownloadStats();
                }, 1500);
            }
            if (!hasActive && progressTimer) {
                clearInterval(progressTimer);
                progressTimer = null;
            }
        }

        // Remove single download from history
        async function removeDownload(downloadId) {
            const userId = clerk.user?.id;
            if (!userId) return;

            if (confirm('Remove this item from your offline library?')) {
                let downloads = getOfflineLibrary(userId);
                const removed = downloads.find(d => d.id === downloadId);
                downloads = downloads.filter(d => d.id !== downloadId);
                saveOfflineLibrary(userId, downloads);

                if (removed && removed.cacheKey) {
                    const cache = await caches.open(OFFLINE_CACHE_NAME);
                    await cache.delete(removed.cacheKey);
                }

                loadDownloads();
                loadDownloadStats();
                showNotification('Download removed from history', 'success');
            }
        }

        // Clear all downloads
        async function clearAllDownloads() {
            const userId = clerk.user?.id;
            if (!userId) return;

            if (confirm('Clear all offline downloads? This cannot be undone.')) {
                const downloads = getOfflineLibrary(userId);
                const cache = await caches.open(OFFLINE_CACHE_NAME);
                for (const item of downloads) {
                    if (item.cacheKey) {
                        await cache.delete(item.cacheKey);
                    }
                }

                saveOfflineLibrary(userId, []);
                loadDownloads();
                loadDownloadStats();
                showNotification('Download history cleared', 'success');
            }
        }

        async function playOfflineItem(downloadId) {
            const userId = clerk.user?.id;
            if (!userId) return;

            const downloads = getOfflineLibrary(userId);
            const entry = downloads.find(item => item.id === downloadId);
            if (!entry || !entry.cacheKey) {
                showNotification('Offline file not found', 'error');
                return;
            }

            const cache = await caches.open(OFFLINE_CACHE_NAME);
            const response = await cache.match(entry.cacheKey);
            if (!response) {
                showNotification('Offline file missing from cache', 'error');
                return;
            }

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const container = document.getElementById(`player-${downloadId}`);
            if (!container) return;

            container.innerHTML = `
                <video controls autoplay src="${url}"></video>
            `;
            container.style.display = 'block';
        }

        async function openOfflineSubtitle(downloadId) {
            const userId = clerk.user?.id;
            if (!userId) return;

            const downloads = getOfflineLibrary(userId);
            const entry = downloads.find(item => item.id === downloadId);
            if (!entry || !entry.cacheKey) {
                showNotification('Subtitle not found', 'error');
                return;
            }

            const cache = await caches.open(OFFLINE_CACHE_NAME);
            const response = await cache.match(entry.cacheKey);
            if (!response) {
                showNotification('Subtitle missing from cache', 'error');
                return;
            }

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${entry.title}.srt`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function retryOfflineItem(downloadId) {
            showNotification('Please re-download from the movie details page', 'info');
        }

        // Show unauthenticated state
        function showUnauthenticatedState() {
            const downloadsList = document.getElementById('downloadsList');
            downloadsList.dataset.loaded = 'true';
            downloadsList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-lock"></i>
                    <h3>Sign in required</h3>
                    <p class="muted">Sign in to view and manage your download history.</p>
                    <button onclick="openSignIn()" class="btn primary">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                </div>
            `;
        }

        // Sign out user
        async function signOutUser() {
            if (confirm('Sign out of your account?')) {
                try {
                    await clerk.signOut();
                    window.location.reload();
                } catch (error) {
                    console.error('Sign out failed:', error);
                    showNotification('Failed to sign out', 'error');
                }
            }
        }

        // Format date
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days} days ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatBytes(bytes) {
            if (!bytes) return '0 MB';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            const value = bytes / Math.pow(1024, i);
            return `${value.toFixed(1)} ${sizes[i]}`;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: ${type === 'error' ? '#e50914' : type === 'success' ? '#4caf50' : '#9147ff'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
                z-index: 3000;
                animation: slideInRight 0.3s ease;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function showError(message) {
            const downloadsList = document.getElementById('downloadsList');
            downloadsList.dataset.loaded = 'true';
            downloadsList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-circle" style="color: #e50914;"></i>
                    <h3>Error</h3>
                    <p class="muted">${message}</p>
                    <button onclick="window.location.reload()" class="btn primary">Retry</button>
                </div>
            `;
        }

        // Animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Service Worker registration for background downloads
        let swReady = false;
        let serviceWorker = null;

        async function initializeServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    console.log('[SW] Registering Service Worker from /sw.js on downloads page...');
                    const registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
                    console.log('[SW] Service Worker registered successfully on downloads page:', registration);
                    serviceWorker = registration;
                    
                    // Listen for messages from service worker
                    navigator.serviceWorker.addEventListener('message', handleServiceWorkerMessage);
                    console.log('[SW] Message listener attached on downloads page');
                    
                    // Check if controller is already active
                    if (navigator.serviceWorker.controller) {
                        console.log('[SW] Controller already active on downloads page');
                        swReady = true;
                    } else {
                        console.log('[SW] Waiting for controller to activate on downloads page...');
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            if (newWorker) {
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'activated') {
                                        console.log('[SW] Controller activated on downloads page!');
                                        swReady = true;
                                    }
                                });
                            }
                        });
                        
                        // Also listen for controller change
                        navigator.serviceWorker.addEventListener('controllerchange', () => {
                            console.log('[SW] Controller changed on downloads page - now active');
                            swReady = true;
                        });
                    }
                } catch (error) {
                    console.error('[SW] Service Worker registration failed on downloads page:', error);
                    swReady = false;
                }
            }
        }

        // Handle messages from service worker
        function handleServiceWorkerMessage(event) {
            const { type, payload } = event.data;
            console.log('[MSG] Received from SW on downloads page:', type);
            
            // Use userId from payload (sent by SW) since clerk might not be loaded yet
            const userId = payload?.userId;
            if (!userId) {
                console.warn('[MSG] No userId in SW message, cannot update');
                return;
            }
            
            if (type === 'DOWNLOAD_PROGRESS') {
                const { entryId, receivedBytes, totalBytes, progress, cacheKey } = payload;
                updateOfflineEntry(userId, entryId, {
                    status: 'downloading',
                    progress,
                    receivedBytes,
                    totalBytes,
                    cacheKey: cacheKey || undefined
                });
                // Refresh the UI if the download is visible
                if (window.loadDownloads) {
                    loadDownloads();
                }
            } else if (type === 'DOWNLOAD_COMPLETE') {
                const { entryId, title, cacheKey } = payload;
                updateOfflineEntry(userId, entryId, {
                    status: 'ready',
                    progress: 100,
                    cacheKey: cacheKey || undefined,
                    cachedAt: Date.now()
                });
                if (window.loadDownloads) {
                    loadDownloads();
                }
                console.log('[MSG] Download completed:', entryId);
            } else if (type === 'DOWNLOAD_FAILED') {
                const { entryId, error, cacheKey } = payload;
                updateOfflineEntry(userId, entryId, {
                    status: 'failed',
                    error,
                    cacheKey: cacheKey || undefined
                });
                if (window.loadDownloads) {
                    loadDownloads();
                }
                console.log('[MSG] Download failed:', entryId, error);
            }
        }

        // Initialize on page load
        async function initializeDownloadsPageFull() {
            await initializeServiceWorker();
            await initializeDownloadsPage();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDownloadsPageFull);
        } else {
            initializeDownloadsPageFull();
        }
    </script>
</body>
</html>
