<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - CinemaHub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Grotesk:wght@400..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Clerk Authentication SDK -->
    <script
        async
        crossorigin="anonymous"
        data-clerk-publishable-key="pk_test_ZXhjaXRpbmctcGlnbGV0LTIzLmNsZXJrLmFjY291bnRzLmRldiQ"
        src="https://exciting-piglet-23.clerk.accounts.dev/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
        type="text/javascript"
    ></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #07070c;
            background-image: radial-gradient(circle at 20% 30%, rgba(45, 20, 80, 0.25) 0%, transparent 40%),
                              radial-gradient(circle at 80% 70%, rgba(90, 30, 120, 0.15) 0%, transparent 45%);
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: #ffffff;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .site-header {
            padding: 1.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            backdrop-filter: blur(10px);
            background: rgba(7,7,12,0.7);
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }

        .brand-mark {
            background: linear-gradient(145deg, #aa5eff, #7c3ced);
            padding: 0.5rem;
            border-radius: 8px;
            color: white;
            font-size: 1.4rem;
            box-shadow: 0 0 12px #9147ff55;
        }

        .brand-text {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            background: linear-gradient(to right, #ffffff, #e0d0ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 2.8rem;
            font-weight: 500;
        }

        .nav-links a {
            color: #c2c2d6;
            transition: 0.2s;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            text-decoration: none;
            border-bottom: 2px solid transparent;
            padding-bottom: 0.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links a:hover {
            color: white;
            border-bottom-color: #aa5eff;
        }

        h1, h2 {
            font-family: 'Bebas Neue', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        h1 {
            font-size: 3rem;
            line-height: 1.1;
            margin-bottom: 1.5rem;
        }

        h2 {
            font-size: 1.8rem;
            margin: 2.5rem 0 1.5rem;
        }

        h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .muted {
            color: #9191a8;
            font-size: 0.95rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            padding: 0.8rem 2rem;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            transition: 0.15s ease;
            border: none;
            cursor: pointer;
            text-decoration: none;
        }

        .btn.primary {
            background: linear-gradient(145deg, #9147ff, #7735d8);
            box-shadow: 0 10px 20px -5px #5e2ab3;
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn.primary:hover {
            background: #a35eff;
            transform: translateY(-2px);
        }

        .btn.secondary {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
        }

        .btn.secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .settings-section select {
            background: rgba(18, 18, 26, 0.9);
            color: #ffffff;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .settings-section select option {
            background: #14141e;
            color: #ffffff;
        }

        /* User Profile Styles in Nav */
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar-nav {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #9147ff;
            box-shadow: 0 0 12px rgba(145, 71, 255, 0.4);
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: #fff;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .btn-outline {
            padding: 0.5rem 1.2rem;
            border: 1px solid rgba(145, 71, 255, 0.5);
            background: rgba(145, 71, 255, 0.1);
            color: #aa5eff;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            transition: all 0.2s;
        }

        .btn-outline:hover {
            background: rgba(145, 71, 255, 0.2);
            border-color: #9147ff;
            color: #fff;
        }

        main {
            padding: 3rem 0;
            min-height: calc(100vh - 200px);
        }

        .profile-header {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 2rem;
            align-items: center;
            background: rgba(13, 13, 20, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 2.5rem;
            border-radius: 32px;
            margin-bottom: 3rem;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(145deg, #9147ff, #7735d8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            box-shadow: 0 0 20px #9147ff55;
        }

        .profile-info h1 {
            margin: 0;
            font-size: 2rem;
        }

        .profile-actions {
            display: flex;
            gap: 1rem;
        }

        .settings-section {
            background: rgba(13, 13, 20, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 2.5rem;
            border-radius: 24px;
            margin-bottom: 2rem;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label h4 {
            margin-bottom: 0.25rem;
        }

        .toggle {
            width: 50px;
            height: 28px;
            background: rgba(255,255,255,0.1);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .toggle.active {
            background: #9147ff;
            border-color: #9147ff;
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: 0.2s;
        }

        .toggle.active::after {
            left: 26px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: rgba(13, 13, 20, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 2rem;
            border-radius: 24px;
        }

        .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            color: #aa5eff;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #9191a8;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .footer {
            background: #030307;
            padding-top: 4rem;
            padding-bottom: 2rem;
            border-top: 1px solid #1a1a28;
            margin-top: 4rem;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .footer a {
            display: block;
            color: #aaaac0;
            margin: 0.8rem 0;
            font-size: 0.95rem;
            text-decoration: none;
            transition: 0.2s;
        }

        .footer a:hover {
            color: #ffffff;
        }

        .footer h4 {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .footer-bottom {
            text-align: center;
            padding: 2rem 0;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        @media (max-width: 768px) {
            /* Mobile Bottom Navigation */
            body {
                padding-left: 0;
                padding-bottom: 80px;
            }

            .site-header {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                width: 100%;
                height: auto;
                padding: 0.8rem 0;
                border-right: none;
                border-top: 1px solid rgba(255,255,255,0.08);
                border-bottom: none;
                background: rgba(7,7,12,0.95);
                backdrop-filter: blur(20px);
                z-index: 1000;
            }

            .nav {
                flex-direction: row;
                justify-content: space-around;
                align-items: center;
                gap: 0;
                height: auto;
                width: 100%;
            }

            .brand {
                display: none;
            }

            .nav-links {
                flex-direction: row;
                width: 100%;
                justify-content: space-around;
                align-items: center;
                gap: 0;
            }

            .nav-links a {
                flex-direction: column;
                justify-content: center;
                font-size: 0.7rem;
                padding: 0;
                border: none;
                gap: 0.4rem;
                color: #9191a8;
                width: auto;
            }

            .nav-links a.active {
                color: #aa5eff;
            }

            .nav-links a i {
                font-size: 1.4rem;
                margin-bottom: 2px;
            }
            
            .nav-links a span {
                display: block !important;
                font-size: 0.65rem;
                font-weight: 500;
                letter-spacing: 0.05em;
            }

            .nav-actions {
                display: none !important;
            }

            /* Fix Mobile Preferences and Stats */
            .profile-header {
                grid-template-columns: 1fr;
                text-align: center;
                padding: 1.5rem;
            }

            .profile-info h1 {
                font-size: 1.5rem;
            }

            .profile-actions {
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .stat-card {
                padding: 1.2rem;
            }

            .stat-value {
                font-size: 1.8rem;
            }

            .setting-row {
                padding: 1rem 0;
            }
            
            .setting-label h4 {
                font-size: 0.95rem;
            }
            
            .setting-label p {
                font-size: 0.8rem;
                max-width: 250px;
            }

            .toggle {
                flex-shrink: 0; /* Prevent toggle from squishing */
                margin-left: 1rem;
            }
            
            select.btn {
               padding: 0.5rem 1rem !important;
               max-width: 140px; 
            }
        }
    </style>
    <style>
        @media (max-width: 420px) {
            .container { max-width: 100% !important; margin: 0 !important; padding: 0 12px !important; }
            .nav-links { gap: 0.6rem !important; }
            h1 { font-size: 1.8rem !important; }
            h2 { font-size: 1.2rem !important; }
            .hero, .hero-grid, .details-layout { grid-template-columns: 1fr !important; gap: 1rem !important; }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <nav class="nav">
                <a class="brand" href="index.html">
                    <span class="brand-mark"><i class="fas fa-film"></i></span>
                    <span class="brand-text">CinemaHub</span>
                </a>
                <div class="nav-links">
                    <a href="index.html"><i class="fas fa-house"></i><span>Home</span></a>
                    <a href="about.html"><i class="fas fa-circle-info"></i><span>About</span></a>
                    <a href="downloads.html"><i class="fas fa-download"></i><span>Downloads</span></a>
                    <a href="profile.html"><i class="fas fa-user"></i><span>Profile</span></a>
                </div>
                <div class="nav-actions" style="display: flex; gap: 1rem; align-items: center;">
                    <div id="userProfile" style="display: flex; gap: 1rem; align-items: center;"></div>
                </div>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Profile Header -->
            <section class="profile-header" id="profileHeader">
                <div class="spinner" style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                    <div style="width: 40px; height: 40px; border: 4px solid rgba(145, 71, 255, 0.2); border-top-color: #9147ff; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto;"></div>
                    <p style="margin-top: 1rem; color: #9191a8;">Loading profile...</p>
                </div>
            </section>

            <!-- Stats -->
            <section id="statsSection">
                <h2>Your Activity</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="searchCount">0</div>
                        <div class="stat-label">Searches Made</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="moviesViewed">0</div>
                        <div class="stat-label">Movies Viewed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="downloadsCount">0</div>
                        <div class="stat-label">Downloads</div>
                    </div>
                </div>
            </section>

            <!-- Preferences -->
            <section>
                <h2>Preferences</h2>
                <div class="settings-section">
                    <div class="setting-row">
                        <div class="setting-label">
                            <h4>Email notifications</h4>
                            <p class="muted">Get notified about new releases and recommendations.</p>
                        </div>
                        <div class="toggle" id="emailNotifications" data-pref="emailNotifications"></div>
                    </div>
                    <div class="setting-row">
                        <div class="setting-label">
                            <h4>Auto-play next episode</h4>
                            <p class="muted">Automatically play the next episode in a series.</p>
                        </div>
                        <div class="toggle active" id="autoPlay" data-pref="autoPlay"></div>
                    </div>
                    <div class="setting-row">
                        <div class="setting-label">
                            <h4>Personalized recommendations</h4>
                            <p class="muted">Improve recommendations based on your watch history.</p>
                        </div>
                        <div class="toggle active" id="recommendations" data-pref="recommendations"></div>
                    </div>
                </div>
            </section>

            <!-- Playback Settings -->
            <section>
                <h2>Playback Settings</h2>
                <div class="settings-section">
                    <div class="setting-row">
                        <div class="setting-label">
                            <h4>Default subtitle language</h4>
                            <p class="muted" id="subtitleLang">English</p>
                        </div>
                        <select id="subtitleSelect" class="btn secondary" style="padding: 0.6rem 1.5rem; font-size: 0.85rem; cursor: pointer;">
                            <option value="en">English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="it">Italian</option>
                            <option value="pt">Portuguese</option>
                            <option value="ja">Japanese</option>
                            <option value="ko">Korean</option>
                            <option value="zh">Chinese</option>
                        </select>
                    </div>
                    <div class="setting-row">
                        <div class="setting-label">
                            <h4>Default video quality</h4>
                            <p class="muted" id="videoQuality">Adaptive (automatic)</p>
                        </div>
                        <select id="qualitySelect" class="btn secondary" style="padding: 0.6rem 1.5rem; font-size: 0.85rem; cursor: pointer;">
                            <option value="auto">Adaptive (automatic)</option>
                            <option value="1080">1080p (Full HD)</option>
                            <option value="720">720p (HD)</option>
                            <option value="480">480p (SD)</option>
                            <option value="360">360p (Low)</option>
                        </select>
                    </div>
                    <div class="setting-row">
                        <div class="setting-label">
                            <h4>Download quality</h4>
                            <p class="muted" id="downloadQuality">HD (1080p)</p>
                        </div>
                        <select id="downloadSelect" class="btn secondary" style="padding: 0.6rem 1.5rem; font-size: 0.85rem; cursor: pointer;">
                            <option value="1080">1080p (Full HD)</option>
                            <option value="720">720p (HD)</option>
                            <option value="480">480p (SD)</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- Account -->
            <section>
                <h2>Account</h2>
                <div class="settings-section">
                    <div class="setting-row">
                        <div class="setting-label">
                            <h4>Manage Account</h4>
                            <p class="muted">Update email, password, security settings, and more.</p>
                        </div>
                        <button id="openUserProfile" class="btn secondary" style="padding: 0.6rem 1.5rem; font-size: 0.85rem;">Manage</button>
                    </div>
                    <div class="setting-row" style="margin-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
                        <button id="signOutBtn" class="btn secondary">
                            <i class="fas fa-sign-out-alt"></i> Sign Out
                        </button>
                        <button id="clearDataBtn" class="btn secondary" style="color: #ff6b6b;">
                            <i class="fas fa-trash"></i> Clear Activity Data
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <div class="container footer-grid">
            <div>
                <div class="brand" style="margin-bottom: 1rem;">
                    <span class="brand-mark"><i class="fas fa-film"></i></span>
                    <span class="brand-text">CinemaHub</span>
                </div>
                <p class="muted">Discovery, streaming, and downloads built for movie lovers.</p>
            </div>
            <div>
                <h4>Explore</h4>
                <a href="index.html">Home</a>
                <a href="about.html">About</a>
                <a href="downloads.html">Downloads</a>
            </div>
            <div>
                <h4>Account</h4>
                <a href="login.html">Log in</a>
                <a href="signup.html">Sign up</a>
            </div>
            <div>
                <h4>Data</h4>
                <p class="muted">Powered by Free Movie DB API.</p>
                <a href="https://imdb.iamidiotareyoutoo.com/docs/index.html" target="_blank" rel="noopener">API Docs</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p class="muted">&copy; 2026 CinemaHub. All rights reserved.</p>
        </div>
    </footer>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .user-profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .user-profile-modal.active {
            display: flex;
        }
        
        .user-profile-container {
            background: #0d0d14;
            border-radius: 24px;
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .close-profile {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .close-profile:hover {
            background: rgba(255,255,255,0.2);
        }
    </style>

    <!-- User Profile Modal -->
    <div class="user-profile-modal" id="userProfileModal">
        <div class="user-profile-container">
            <button class="close-profile" onclick="closeUserProfileModal()">
                <i class="fas fa-times"></i>
            </button>
            <div id="userProfileComponent"></div>
        </div>
    </div>

    <script>
        // Clerk instance
        let clerk = null;
        const CLERK_PUBLISHABLE_KEY = 'pk_test_ZXhjaXRpbmctcGlnbGV0LTIzLmNsZXJrLmFjY291bnRzLmRldiQ';

        // Initialize Clerk and load profile
        async function initializeProfile() {
            try {
                // Wait for Clerk SDK
                let attempts = 0;
                while (!window.Clerk && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (!window.Clerk) {
                    showError('Authentication system failed to load. Please refresh the page.');
                    return;
                }

                clerk = window.Clerk;
                await clerk.load({
                    publishableKey: CLERK_PUBLISHABLE_KEY,
                });

                // Check if user is authenticated
                if (!clerk.user) {
                    // Redirect to home if not logged in
                    window.location.href = '/index.html';
                    return;
                }

                // Load user profile
                loadUserProfile();
                loadUserStats();
                loadUserPreferences();
                setupEventListeners();
                updateNavProfile();

            } catch (error) {
                console.error('Failed to initialize profile:', error);
                showError('Failed to load profile. Please try again.');
            }
        }

        // Load user profile data
        function loadUserProfile() {
            const user = clerk.user;
            const profileHeader = document.getElementById('profileHeader');

            const userName = user.firstName ? `${user.firstName} ${user.lastName || ''}`.trim() : user.username || 'User';
            const userEmail = user.primaryEmailAddress?.emailAddress || '';
            const userImage = user.imageUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=9147ff&color=fff`;
            const joinDate = new Date(user.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });

            profileHeader.innerHTML = `
                <div class="profile-avatar" style="background-image: url('${userImage}'); background-size: cover; background-position: center;">
                    ${!user.imageUrl ? '<i class="fas fa-user"></i>' : ''}
                </div>
                <div class="profile-info">
                    <h1>${userName}</h1>
                    <p class="muted">${userEmail}${joinDate ? ' â€¢ Member since ' + joinDate : ''}</p>
                </div>
                <div class="profile-actions">
                    <button class="btn secondary" onclick="openUserProfileModal()">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                </div>
            `;
        }

        // Update navigation bar with user profile
        function updateNavProfile() {
            const user = clerk.user;
            const userProfileNav = document.getElementById('userProfile');
            
            if (!userProfileNav || !user) return;

            const userName = user.firstName || user.username || 'User';
            const userImage = user.imageUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=9147ff&color=fff`;

            userProfileNav.innerHTML = `
                <div class="user-info">
                    <img src="${userImage}" alt="${userName}" class="user-avatar-nav">
                    <span class="user-name">${userName}</span>
                </div>
            `;
        }

        // Load user activity stats from localStorage
        function loadUserStats() {
            const userId = clerk.user?.id;
            if (!userId) return;

            const stats = JSON.parse(localStorage.getItem(`userStats_${userId}`)) || {
                searchCount: 0,
                moviesViewed: 0,
                downloadsCount: 0
            };

            document.getElementById('searchCount').textContent = stats.searchCount;
            document.getElementById('moviesViewed').textContent = stats.moviesViewed;
            document.getElementById('downloadsCount').textContent = stats.downloadsCount;
        }

        // Load user preferences from localStorage
        function loadUserPreferences() {
            const userId = clerk.user?.id;
            if (!userId) return;

            const prefs = JSON.parse(localStorage.getItem(`userPrefs_${userId}`)) || {
                emailNotifications: false,
                autoPlay: true,
                recommendations: true,
                subtitleLang: 'en',
                videoQuality: 'auto',
                downloadQuality: '1080'
            };

            // Set toggles
            document.getElementById('emailNotifications').classList.toggle('active', prefs.emailNotifications);
            document.getElementById('autoPlay').classList.toggle('active', prefs.autoPlay);
            document.getElementById('recommendations').classList.toggle('active', prefs.recommendations);

            // Set selects
            document.getElementById('subtitleSelect').value = prefs.subtitleLang;
            document.getElementById('qualitySelect').value = prefs.videoQuality;
            document.getElementById('downloadSelect').value = prefs.downloadQuality;

            // Update display text
            updatePreferenceDisplays();
        }

        // Save user preferences
        function saveUserPreferences() {
            const userId = clerk.user?.id;
            if (!userId) return;

            const prefs = {
                emailNotifications: document.getElementById('emailNotifications').classList.contains('active'),
                autoPlay: document.getElementById('autoPlay').classList.contains('active'),
                recommendations: document.getElementById('recommendations').classList.contains('active'),
                subtitleLang: document.getElementById('subtitleSelect').value,
                videoQuality: document.getElementById('qualitySelect').value,
                downloadQuality: document.getElementById('downloadSelect').value
            };

            localStorage.setItem(`userPrefs_${userId}`, JSON.stringify(prefs));
            showNotification('Preferences saved', 'success');
        }

        // Update preference display text
        function updatePreferenceDisplays() {
            const subtitleLangs = {
                'en': 'English', 'es': 'Spanish', 'fr': 'French', 'de': 'German',
                'it': 'Italian', 'pt': 'Portuguese', 'ja': 'Japanese', 'ko': 'Korean', 'zh': 'Chinese'
            };
            const qualities = {
                'auto': 'Adaptive (automatic)', '1080': '1080p (Full HD)',
                '720': '720p (HD)', '480': '480p (SD)', '360': '360p (Low)'
            };

            const subtitleSelect = document.getElementById('subtitleSelect');
            const qualitySelect = document.getElementById('qualitySelect');
            const downloadSelect = document.getElementById('downloadSelect');

            document.getElementById('subtitleLang').textContent = subtitleLangs[subtitleSelect.value] || 'English';
            document.getElementById('videoQuality').textContent = qualities[qualitySelect.value] || 'Adaptive (automatic)';
            document.getElementById('downloadQuality').textContent = qualities[downloadSelect.value] || '1080p (Full HD)';
        }

        // Setup event listeners
        function setupEventListeners() {
            // Toggle switches
            document.querySelectorAll('.toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                    saveUserPreferences();
                });
            });

            // Select dropdowns
            document.getElementById('subtitleSelect').addEventListener('change', function() {
                updatePreferenceDisplays();
                saveUserPreferences();
            });
            document.getElementById('qualitySelect').addEventListener('change', function() {
                updatePreferenceDisplays();
                saveUserPreferences();
            });
            document.getElementById('downloadSelect').addEventListener('change', function() {
                updatePreferenceDisplays();
                saveUserPreferences();
            });

            // Sign out button
            document.getElementById('signOutBtn').addEventListener('click', async () => {
                if (confirm('Are you sure you want to sign out?')) {
                    try {
                        await clerk.signOut();
                        window.location.href = '/index.html';
                    } catch (error) {
                        console.error('Sign out failed:', error);
                        showNotification('Failed to sign out', 'error');
                    }
                }
            });

            // Clear data button
            document.getElementById('clearDataBtn').addEventListener('click', () => {
                if (confirm('This will clear all your activity data (searches, views, downloads). This cannot be undone. Continue?')) {
                    const userId = clerk.user?.id;
                    if (userId) {
                        localStorage.removeItem(`userStats_${userId}`);
                        loadUserStats();
                        showNotification('Activity data cleared', 'success');
                    }
                }
            });

            // Open user profile button
            document.getElementById('openUserProfile').addEventListener('click', openUserProfileModal);
        }

        // Open Clerk UserProfile modal
        function openUserProfileModal() {
            const modal = document.getElementById('userProfileModal');
            const container = document.getElementById('userProfileComponent');
            
            // Clear previous content
            container.innerHTML = '';
            
            // Mount Clerk UserProfile component
            clerk.mountUserProfile(container, {
                appearance: {
                    baseTheme: 'dark',
                    variables: {
                        colorPrimary: '#9147ff',
                        colorBackground: '#0d0d14',
                    },
                },
            });
            
            modal.classList.add('active');
        }

        // Close user profile modal
        function closeUserProfileModal() {
            const modal = document.getElementById('userProfileModal');
            modal.classList.remove('active');
            
            // Reload profile in case of changes
            setTimeout(() => {
                if (clerk.user) {
                    loadUserProfile();
                }
            }, 500);
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: ${type === 'error' ? '#e50914' : type === 'success' ? '#4caf50' : '#9147ff'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
                z-index: 3000;
                animation: slideInRight 0.3s ease;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function showError(message) {
            const profileHeader = document.getElementById('profileHeader');
            profileHeader.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                    <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #e50914; margin-bottom: 1rem;"></i>
                    <p style="color: #e50914; font-size: 1.1rem;">${message}</p>
                    <button class="btn primary" onclick="window.location.reload()" style="margin-top: 1rem;">Retry</button>
                </div>
            `;
        }

        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeProfile);
        } else {
            initializeProfile();
        }

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
